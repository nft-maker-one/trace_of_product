<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e0f7fa;
        }
        .navbar {
            background-color: #0288d1;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            color: white;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 4px;
        }
        .navbar a:hover {
            background-color: #0277bd;
        }
        .content {
            padding: 20px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .input-group {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .input-group label {
            margin-bottom: 5px;
        }
        .input-group input, .input-group button {
            padding: 10px;
            width: 250px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .input-group button {
            margin-top: 10px;
            background-color: #0288d1;
            color: white;
            border: none;
            cursor: pointer;
        }
        .input-group button:hover {
            background-color: #0277bd;
        }
        .result-list, .upload-result {
            margin-top: 20px;
            color: #0288d1;
        }
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-info img {
            border-radius: 50%;
            margin-right: 15px;
            width: 100px;
            height: 100px;
        }
        .login-time {
            font-size: 14px;
            color: #555;
        }
        .node-list {
            margin-top: 20px;
        }
        .node-list ul {
            list-style-type: none;
            padding: 0;
        }
        .node-list li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="#personal-center">个人信息</a>
        <a href="#data-upload">数据上传</a>
        <a href="#data-query">数据查询</a>
        <a href="#statistics-distribution">查询在线节点</a>
    </div>

    <div class="content">
        <!-- 个人信息 Tab -->
        <div id="personal-center" class="tab-content active">
            <h2>用户信息</h2>
            <div class="user-info">
                <img src="https://img.taotu.cn/ssd/ssd3/1/2023-06-27/1_a244016164089571ceed6d7e66819b26.jpg" alt="User Avatar">
                <span>欢迎 <span id="username-display">John Doe</span>!</span><br>
                <div class="login-time">(登录时间: <span id="login-time"></span>)</div>
            </div>
        </div>

        <!-- 上传 Tab -->
        <div id="data-upload" class="tab-content">
            <h2>产品数据上传</h2>
            <div class="input-group">
                <label for="upload-eggplant-id">eggplantID:</label>
                <input type="text" id="upload-eggplant-id">
            </div>
            <div class="input-group">
                <label for="upload-product-height">产品高度:</label>
                <input type="text" id="upload-product-height">
            </div>
            <div class="input-group">
                <label for="upload-product-hash">产品哈希:</label>
                <input type="text" id="upload-product-hash">
            </div>
            <div class="input-group">
                <label for="upload-transport-height">运输高度:</label>
                <input type="text" id="upload-transport-height">
            </div>
            <div class="input-group">
                <label for="upload-transport-hash">运输哈希:</label>
                <input type="text" id="upload-transport-hash">
            </div>
            <div class="input-group">
                <label for="upload-process-height">加工高度:</label>
                <input type="text" id="upload-process-height">
            </div>
            <div class="input-group">
                <label for="upload-process-hash">加工哈希:</label>
                <input type="text" id="upload-process-hash">
            </div>
            <div class="input-group">
                <label for="upload-storage-height">存储高度:</label>
                <input type="text" id="upload-storage-height">
            </div>
            <div class="input-group">
                <label for="upload-storage-hash">存储哈希:</label>
                <input type="text" id="upload-storage-hash">
            </div>
            <div class="input-group">
                <label for="upload-sell-height">销售高度:</label>
                <input type="text" id="upload-sell-height">
            </div>
            <div class="input-group">
                <label for="upload-sell-hash">销售哈希:</label>
                <input type="text" id="upload-sell-hash">
            </div>
            <div class="input-group">
                <button onclick="uploadData()">上传</button>
            </div>
            <div class="upload-result" id="upload-result"></div>
        </div>

        <!-- 查询 Tab -->
        <div id="data-query" class="tab-content">
            <h2>产品信息查询</h2>
            <div class="input-group">
                <label for="query-id">eggplantID:</label>
                <input type="text" id="query-id">
            </div>
            <div class="input-group">
                <button onclick="queryData()">查询</button>
            </div>
            <div class="result-list" id="result-list"></div>
        </div>

        <!-- 查询在线节点 Tab -->
        <div id="statistics-distribution" class="tab-content">
            <h2>查询在线节点</h2>
            <div class="node-list" id="node-list">
                <p>加载中...</p>
            </div>
        </div>
    </div>

    <script>
        
        document.getElementById('username-display').textContent = 'John Doe'; // Replace with dynamic username
        document.getElementById('login-time').textContent = new Date().toLocaleString(); // Show current time as login time

        
        function queryData() {
            const queryId = document.getElementById('query-id').value;
            const resultList = document.getElementById('result-list');
            fetch(`http://localhost:8081/message?id=${queryId}`,{
                method:"GET",
                headers:{
                    "Authorization":localStorage.getItem("token"),
                }
            })
                .then(response => response.json())
                .then(data => {
                    data = JSON.parse(data.msg);
                    if (data) {
                        resultList.innerHTML = `
                            <p>Product Height: ${data.product_height}</p>
                            <p>Product Hash: ${bytesToHex(data.product_hash)}</p>
                            <p>Transport Height: ${data.transport_height}</p>
                            <p>Transport Hash: ${bytesToHex(data.transport_hash)}</p>
                            <p>Process Height: ${data.process_height}</p>
                            <p>Process Hash: ${bytesToHex(data.process_hash)}</p>
                            <p>Storage Height: ${data.storage_height}</p>
                            <p>Storage Hash: ${bytesToHex(data.storage_hash)}</p>
                            <p>Sell Height: ${data.sell_height}</p>
                            <p>Sell Hash: ${bytesToHex(data.sell_hash)}</p>
                        `;
                    } else {
                        resultList.innerHTML = '<p>No results found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    resultList.innerHTML = '<p>Error fetching data.</p>';
                });
        }

        function bytesToHex(bytes) {
        let hex = '';
        for (let i = 0; i < bytes.length; i++) {
            let hexValue = bytes[i].toString(16);
            if (hexValue.length === 1) {
            hex += '0';
            }
            hex += hexValue;
        }
        return hex;
        }

        // Upload data
        function uploadData() {
            const eggplantId = parseInt(document.getElementById('upload-eggplant-id').value);
            const productHeight = parseInt(document.getElementById('upload-product-height').value);
            const productHash = document.getElementById('upload-product-hash').value;
            const transportHeight = parseInt(document.getElementById('upload-transport-height').value);
            const transportHash = document.getElementById('upload-transport-hash').value;
            const processHeight = parseInt(document.getElementById('upload-process-height').value);
            const processHash = document.getElementById('upload-process-hash').value;
            const storageHeight = parseInt(document.getElementById('upload-storage-height').value);
            const storageHash = document.getElementById('upload-storage-hash').value;
            const sellHeight = parseInt(document.getElementById('upload-sell-height').value);
            const sellHash = document.getElementById('upload-sell-hash').value;

            if (eggplantId && productHeight && productHash && transportHeight && transportHash && processHeight && processHash && storageHeight && storageHash && sellHeight && sellHash) {
                fetch('http://localhost:8081/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization':localStorage.getItem('token'),
                    },
                    body: JSON.stringify({
                        eggplant_id: eggplantId,
                        product_height: productHeight,
                        product_hash: productHash,
                        transport_height: transportHeight,
                        transport_hash: transportHash,
                        process_height: processHeight,
                        process_hash: processHash,
                        storage_height: storageHeight,
                        storage_hash: storageHash,
                        sell_height: sellHeight,
                        sell_hash: sellHash
                    })
                })
                .then(response => {response.json()})
                .then(data => {
                    document.getElementById('upload-result').textContent = '上传成功!';
                })
                .catch(error => {
                    document.getElementById('upload-result').textContent = '上传失败: ' + error.message;
                });
            } else {
                document.getElementById('upload-result').textContent = '请填写所有必填项。';
            }
        }
        document.querySelectorAll('.navbar a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                const targetId = this.getAttribute('href').substring(1);
                document.getElementById(targetId).classList.add('active');

                if (targetId === 'statistics-distribution') {
                    fetchOnlineNodes();
                }
            });
        });

        
        function fetchOnlineNodes() {
            console.log(localStorage.getItem('token'))
            fetch('http://localhost:8081/nodes',{
                method:"GET",
                headers:{
                    "Authorization":localStorage.getItem('token'),
                }
            })
                .then(response => response.json())
                .then(data => {
                    const nodeList = document.getElementById('node-list');
                    let nodeListHtml = '<ul>';
                    for (const [id, address] of Object.entries(data)) {
                        nodeListHtml += `<li>Node ID: ${id} - Address: ${address}</li>`;
                    }
                    nodeListHtml += '</ul>';
                    nodeList.innerHTML = nodeListHtml;
                })
                .catch(error => {
                    console.error('Error fetching nodes:', error);
                    document.getElementById('node-list').innerHTML = '<p>Error fetching nodes.</p>';
                });
        }

        
        function pollOnlineNodes() {
            fetchOnlineNodes();
            setInterval(fetchOnlineNodes, 5000); // Poll every 5 seconds
        }

        
        document.getElementById('statistics-distribution').addEventListener('click', pollOnlineNodes);
    </script>
</body>
</html>